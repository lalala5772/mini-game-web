<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë¥´ì˜ ì°¸ì°¸ì°¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/facemesh"></script>
    <!-- jQuery CDN ì¶”ê°€ (ìµœì‹  ë²„ì „) -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* height: 100vh; */
            font-family: 'Arial', sans-serif;
        }
        #webcam {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            height: 150px;
            border: 2px solid white;
            transform: scaleX(-1);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        button {
            position: absolute;
            top: 20px;
            padding: 12px 24px;
            font-size: 20px;
            background-color: #ff9800;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        button:hover {
            background-color: #f57c00;
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.95);
        }
        button:disabled {
            background-color: #999;
            cursor: not-allowed;
        }
        #countdown, #chamText, #resultText, #userDirectionText {
            position: absolute;
            font-weight: bold;
            color: white;
            opacity: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #countdown { 
            top: 20px; 
            right: 20px; 
            font-size: 60px;
            color: #ffeb3b;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #chamText { 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: #ff5722;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #userDirectionText { 
            left: 10px; 
            bottom: 50px; 
            font-size: 20px;
            background-color: rgba(0,0,0,0.6);
            padding: 8px 16px;
            border-radius: 20px;
        }
        #resultText {
            top: 50%; 
            right: 20px;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 50px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        #score {
            position: absolute;
            top: 20px;
            left: 230px;
            color: white;
            font-size: 18px;
            background-color: rgba(0,0,0,0.6);
            padding: 10px 15px;
            border-radius: 10px;
        }
        #loadingMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            background-color: rgba(0,0,0,0.7);
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 10;
        }
        .direction-marker {
            position: absolute;
            width: 200px;
            height: 30px;
            top: 220px;
            left: 10px;
            display: flex;
            justify-content: space-between;
            padding: 5px;
            background-color: rgba(0,0,0,0.5);
            border-radius: 8px;
        }
        .marker {
            width: 50px;
            height: 20px;
            border-radius: 4px;
            background-color: #555;
            text-align: center;
            line-height: 20px;
            font-size: 14px;
            color: white;
        }
        .marker.active {
            background-color: #2196F3;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            margin-top: 10px;
        }
        .progress {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s;
        }
        #debugInfo {
            position: absolute;
            top: 260px;
            left: 10px;
            width: 200px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            font-size: 14px;
            padding: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<video id="webcam" autoplay playsinline></video>
<div id="resultText"></div>
<div id="userDirectionText">ì–¼êµ´ ì¸ì‹ ì¤‘...</div>
<div class="direction-marker">
    <div class="marker" id="leftMarker">ì™¼ìª½</div>
    <div class="marker" id="centerMarker">ì¤‘ì•™</div>
    <div class="marker" id="rightMarker">ì˜¤ë¥¸ìª½</div>
</div>
<div id="debugInfo">
    ì–¼êµ´ ë„ˆë¹„: 0px<br>
    ì„ê³„ê°’: 0px<br>
    ë°©í–¥ ì°¨ì´: 0px
</div>
<button id="startBtn">ì‹œì‘í•˜ê¸°</button>
<div id="countdown"></div>
<div id="chamText"></div>
<div id="score">ì‚¬ìš©ì: 0</div>
<div id="loadingMessage">
    ëª¨ë¸ ë¡œë”© ì¤‘...
    <div class="progress-bar">
        <div class="progress" id="loadingProgress"></div>
    </div>
</div>

<input type="hidden" id="gameId" value="4006">

<script>
    // ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì •
    let faceModel;
    let video = document.getElementById("webcam");
    let userDirection = "center"; // ê¸°ë³¸ê°’ ì„¤ì •
    let lastUserDirection = ""; // ìµœì¢… í¬ì§€ì…˜ ì €ì¥ìš©
    let scene, camera, renderer, handModel;
    let handDirection = "center";
    let userScore = 0; //dbì—ì„œ ê°€ì ¸ì˜¤ê¸°
    // let computerScore = 0;
    let isGameRunning = false;
    let isModelLoaded = false;
    let isCameraReady = false;
    
    // ë””ë²„ê·¸ ì •ë³´ ìš”ì†Œ
    const debugInfoElement = document.getElementById("debugInfo");
    
    // UI ìš”ì†Œ
    const startBtn = document.getElementById("startBtn");
    const loadingMessage = document.getElementById("loadingMessage");
    const loadingProgress = document.getElementById("loadingProgress");
    const directionText = document.getElementById("userDirectionText");
    const leftMarker = document.getElementById("leftMarker");
    const centerMarker = document.getElementById("centerMarker");
    const rightMarker = document.getElementById("rightMarker");
    
    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ë””ë²„ê¹…ìš©)
    document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft") setDirection("left");
        else if (e.key === "ArrowDown") setDirection("center");
        else if (e.key === "ArrowRight") setDirection("right");
    });
    
    // ì´ˆê¸°í™” í•¨ìˆ˜
    async function init() {
        startBtn.disabled = true;
        
        try {
            // ë¡œë”© ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            updateLoadingProgress("ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘...", 10);
            
            // ì¹´ë©”ë¼ ì´ˆê¸°í™”
            await setupCamera();
            isCameraReady = true;
            updateLoadingProgress("FaceMesh ëª¨ë¸ ë¡œë”© ì¤‘...", 30);
            
            // AI ëª¨ë¸ ë¡œë“œ
            await loadFaceMesh();
            isModelLoaded = true;
            updateLoadingProgress("3D í™˜ê²½ ì¤€ë¹„ ì¤‘...", 70);
            
            // 3D ì”¬ ì´ˆê¸°í™”
            initThreeJS();
            updateLoadingProgress("ì¤€ë¹„ ì™„ë£Œ!", 100);
            
            // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                loadingMessage.style.display = "none";
            }, 1000);
            
            // ì‹œì‘ ë²„íŠ¼ í™œì„±í™”
            startBtn.disabled = false;
            
        } catch (error) {
            console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
            loadingMessage.innerHTML = "ëª¨ë¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            loadingProgress.style.width = "0%";
            // window.location.href = "/errorPage.jsp"; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ë™í•  í˜ì´ì§€
        }
    }
    
    // ë¡œë”© ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    function updateLoadingProgress(message, percent) {
        loadingMessage.innerHTML = message + 
            `<div class="progress-bar">
                <div class="progress" id="loadingProgress" style="width: ${percent}%"></div>
            </div>`;
    }

    
    // ì¹´ë©”ë¼ ì„¤ì •
    async function setupCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    width: 640, 
                    height: 480,
                    facingMode: "user"
                }
            });
            
            video.srcObject = stream;
            
            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve();
                };
            });
        } catch (error) {
            console.error("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:", error);
            throw new Error("ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
    // FaceMesh ëª¨ë¸ ë¡œë“œ (ì›ë³¸ ì½”ë“œì—ì„œ ì‚¬ìš©í–ˆë˜ ë°©ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    async function loadFaceMesh() {
        try {
            faceModel = await facemesh.load();
            
            // ì–¼êµ´ ê°ì§€ ì‹œì‘
            detectFace();
            
            return faceModel;
        } catch (error) {
            console.error("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:", error);
            throw new Error("AI ëª¨ë¸ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    }
    
    // ì–¼êµ´ ê°ì§€ (ë™ì  ì„ê³„ê°’ ì ìš©)
    async function detectFace() {
        if (!faceModel) return;
        
        try {
            const predictions = await faceModel.estimateFaces(video);
            
            if (predictions.length > 0) {
                const keypoints = predictions[0].scaledMesh;
                const nose = keypoints[1];  // ì½”ì˜ ìœ„ì¹˜
                
                // ì–¼êµ´ ì–‘ìª½ ë í¬ì¸íŠ¸ (ê·€ ë¶€ê·¼ ë˜ëŠ” ëˆˆ ë°”ê¹¥ìª½ ëª¨ì„œë¦¬ ì‚¬ìš©)
                const leftEye = keypoints[33];   // ì™¼ìª½ ëˆˆ ì£¼ë³€ ëœë“œë§ˆí¬
                const rightEye = keypoints[263]; // ì˜¤ë¥¸ìª½ ëˆˆ ì£¼ë³€ ëœë“œë§ˆí¬
                
                // ì–¼êµ´ ë„ˆë¹„ ê³„ì‚° (ëˆˆ ì‚¬ì´ ê±°ë¦¬)
                const faceWidth = Math.abs(rightEye[0] - leftEye[0]);
                
                // ë™ì  ì„ê³„ê°’ ê³„ì‚° (ì–¼êµ´ ë„ˆë¹„ì˜ 15%)
                const dynamicThreshold = faceWidth * 0.15;
                
                // ì–¼êµ´ ì¤‘ì•™ê°’ ê³„ì‚°
                const faceCenter = (keypoints[234][0] + keypoints[454][0]) / 2;
                
                // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
                debugInfoElement.innerHTML = `ì–¼êµ´ ë„ˆë¹„: ${Math.round(faceWidth)}px<br>
                ì„ê³„ê°’: ${Math.round(dynamicThreshold)}px<br>
                ë°©í–¥ ì°¨ì´: ${Math.round(Math.abs(nose[0] - faceCenter))}px`;
                
                // ì–¼êµ´ ë°©í–¥ íŒë³„ (ë™ì  ì„ê³„ê°’ ì‚¬ìš©)
                if (Math.abs(nose[0] - faceCenter) < dynamicThreshold) {
                    setDirection("center");
                } else {
                    setDirection(nose[0] < faceCenter ? "right" : "left");
                }
            }
        } catch (error) {
            console.error("ì–¼êµ´ ê°ì§€ ì˜¤ë¥˜:", error);
        }
        
        requestAnimationFrame(detectFace);
    }
    
    // ë°©í–¥ ì„¤ì • í•¨ìˆ˜
    function setDirection(direction) {
        userDirection = direction;
        updateDirectionUI();
    }
    
    // ë°©í–¥ UI ì—…ë°ì´íŠ¸
    function updateDirectionUI() {
        // ëª¨ë“  ë§ˆì»¤ ë¹„í™œì„±í™”
        leftMarker.classList.remove("active");
        centerMarker.classList.remove("active");
        rightMarker.classList.remove("active");
        
        // ë°©í–¥ í…ìŠ¤íŠ¸ ë° ë§ˆì»¤ ì—…ë°ì´íŠ¸
        if (userDirection === "left") {
            directionText.innerText = "ë°©í–¥: ì™¼ìª½";
            leftMarker.classList.add("active");
        } else if (userDirection === "center") {
            directionText.innerText = "ë°©í–¥: ì¤‘ì•™";
            centerMarker.classList.add("active");
        } else if (userDirection === "right") {
            directionText.innerText = "ë°©í–¥: ì˜¤ë¥¸ìª½";
            rightMarker.classList.add("active");
        } else {
            directionText.innerText = "ë°©í–¥ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
        }
    }

    function initThreeJS() {
        // Three.js ì´ˆê¸°í™”
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x222222);
        
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0.04, 0.5);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(2, 2, 2).normalize();
        scene.add(light);
        
        const loader = new THREE.GLTFLoader();
        loader.load("assets/hand.glb", function (gltf) {
            handModel = gltf.scene;
            handModel.scale.set(1, 1, 1);
            scene.add(handModel);
            handModel.rotation.x = -Math.PI / 2;
            handModel.rotation.y = -Math.PI / 2;
            animate();
        });
        
        window.addEventListener("resize", onWindowResize);
    }
    
    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }

    function startGame() {
        if (isGameRunning) return;
        isGameRunning = true;
        
        // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
        lastUserDirection = "";
        
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        startBtn.disabled = true;
        
        // ëª¨ë¸ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
        handModel.rotation.x = -Math.PI / 2;
        handModel.rotation.y = -Math.PI / 2;
        handModel.rotation.z = 0;
        
        chamSequence();
    }
    
    
    function chamSequence() {
        let chamText = document.getElementById("chamText");
        
        // ì²« ë²ˆì§¸ "ì°¸"
        chamText.innerText = "ì°¸";
        chamText.style.opacity = 1;
        gsap.from(chamText, {scale: 0, duration: 0.3});
        
        // ì† í”ë“¤ê¸° ì• ë‹ˆë©”ì´ì…˜
        gsap.to(handModel.position, {
            y: "+=0.15",
            duration: 0.5,
            repeat: 3,
            yoyo: true,
        });
        
        // 1ì´ˆ í›„ ë‘ ë²ˆì§¸ "ì°¸"
        setTimeout(() => {
            chamText.innerText = "ì°¸";
            gsap.from(chamText, {scale: 0.5, duration: 0.3});
            
            // 1ì´ˆ í›„ ì„¸ ë²ˆì§¸ "ì°¸"
            setTimeout(() => {
                chamText.innerText = "ì°¸!";
                gsap.from(chamText, {scale: 0.5, duration: 0.3});
                
                // ì„¸ ë²ˆì§¸ "ì°¸!" í…ìŠ¤íŠ¸ê°€ ì¶œë ¥ëœ í›„ 1ì´ˆ í›„ì— í˜ì´ë“œ ì•„ì›ƒ ì‹œì‘
                setTimeout(() => {
                    // í…ìŠ¤íŠ¸ í˜ì´ë“œ ì•„ì›ƒ ì‹œì‘
                    chamText.style.opacity = 0;
                    
                    // í…ìŠ¤íŠ¸ê°€ ì™„ì „íˆ ì‚¬ë¼ì§ˆ ë•Œ ë°©í–¥ ìº¡ì²˜ (ì•½ 0.8ì´ˆ í›„)
                    setTimeout(() => {
                        // ë°©í–¥ ìº¡ì²˜
                        lastUserDirection = userDirection;
                        console.log("ë°©í–¥ ìº¡ì²˜ë¨:", lastUserDirection);
                        
                        // ì† ë°©í–¥ ê²°ì • ë° ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                        determineHandDirection();
                    }, 800);
                }, 1000);
            }, 1000);
        }, 1000);
    }

    function determineHandDirection() {
        // ëœë¤ìœ¼ë¡œ ì¢Œ/ìš° ê²°ì •
        let direction = Math.random() < 0.5 ? -1 : 1;
        
        // ë°©í–¥ ì„¤ì •
        handDirection = direction === -1 ? "left" : "right";
        
        // ì‚¬ìš©ìê°€ ì¤‘ì•™ì´ë©´ í•­ìƒ íŒ¨ë°°í•˜ë„ë¡ ì„¤ì •
        if (lastUserDirection === "center") {
            // ëœë¤ ë°©í–¥ ìœ ì§€ (ì¤‘ì•™ì€ í•­ìƒ íŒ¨ë°°)
        } else {
            // ëœë¤ì„± ì¶”ê°€ (50% í™•ë¥ ë¡œ ê°™ì€ ë°©í–¥ = íŒ¨ë°°)
            if (Math.random() < 0.5) {
                // ê°™ì€ ë°©í–¥ìœ¼ë¡œ ì„¤ì • (íŒ¨ë°°)
                direction = lastUserDirection === "left" ? -1 : 1;
                handDirection = lastUserDirection;
                userScore -= 30;
            } else {
                // ë‹¤ë¥¸ ë°©í–¥ìœ¼ë¡œ ì„¤ì • (ìŠ¹ë¦¬)
                direction = lastUserDirection === "left" ? 1 : -1;
                handDirection = lastUserDirection === "left" ? "right" : "left";
                userScore += 20;
                //ìŠ¤ì½”ì–´ dbì—…ë¡œë“œí•˜ëŠ” í•¨ìˆ˜ 
            }
        }
        
        // ì† íšŒì „ ì ìš© (ì›ë³¸ ì½”ë“œì˜ íšŒì „ ë°©ì‹ ì‚¬ìš©)
        if (direction === -1) {
            // ì™¼ìª½
            gsap.to(handModel.rotation, {
                x: 0,
                y: -Math.PI,
                z: Math.PI / 2,
                duration: 0.4,
                ease: "power2.out",
                onComplete: () => {
                    setTimeout(checkResult, 500);
                }
            });
        } else {
            // ì˜¤ë¥¸ìª½
            gsap.to(handModel.rotation, {
                x: 0,
                y: 0,
                z: Math.PI / 2,
                duration: 0.4,
                ease: "power2.out",
                onComplete: () => {
                    setTimeout(checkResult, 500);
                }
            });
        }
    }
    
    function checkResult() {
        let scoreDisplay = document.getElementById("score");    
    let resultText = document.getElementById("resultText");

    if (lastUserDirection === "center") {
        // ì¤‘ì•™ì€ í•­ìƒ íŒ¨ë°°
        resultText.innerText = "ì¤‘ì•™ì€ íŒ¨ë°°! ğŸ˜­";
        resultText.style.color = "red";
        sendGameRecord(-30);
    } else if (lastUserDirection === handDirection) {
        // ê°™ì€ ë°©í–¥ì´ë©´ íŒ¨ë°°
        resultText.innerText = "íŒ¨ë°°! ğŸ˜­";
        resultText.style.color = "red";
        sendGameRecord(-30);
    } else {
        // ë‹¤ë¥¸ ë°©í–¥ì´ë©´ ìŠ¹ë¦¬
        resultText.innerText = "ìŠ¹ë¦¬! ğŸ‰";
        resultText.style.color = "green";
        sendGameRecord(20);
    }

    // ì ìˆ˜ ì—…ë°ì´íŠ¸
    scoreDisplay.innerText = `ì‚¬ìš©ì: ${userScore}`;

    // ê²°ê³¼ í…ìŠ¤íŠ¸ ì• ë‹ˆë©”ì´ì…˜
    resultText.style.opacity = 0;
    gsap.to(resultText, {
        opacity: 1, 
        scale: 1.2, 
        duration: 0.3,
        onComplete: () => {
            gsap.to(resultText, {
                scale: 1, 
                duration: 0.2
            });
            
            setTimeout(() => {
                gsap.to(resultText, {
                    opacity: 0,
                    duration: 0.5,
                    onComplete: () => {
                        // ì†ì„ ì´ˆê¸° ìœ„ì¹˜ë¡œ ë¦¬ì…‹
                        resetHandPosition();
                    }
                });
            }, 1500);
        }
    });
}

    
    function resetHandPosition() {
        // ì†ì„ ì´ˆê¸° ìœ„ì¹˜ë¡œ ë¶€ë“œëŸ½ê²Œ ëŒë ¤ë†“ê¸°
        gsap.to(handModel.rotation, {
            x: -Math.PI / 2,
            y: -Math.PI / 2,
            z: 0,
            duration: 0.8,
            ease: "power2.inOut",
            onComplete: () => {
                isGameRunning = false;
                startBtn.disabled = false;
            }
        });
    }

    // ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    startBtn.addEventListener("click", startGame);
   
    // ì´ˆê¸°í™” ì‹œì‘
    init();
</script>

<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶€ëª¨ ì°½ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
let userId;

// URL íŒŒë¼ë¯¸í„°ì—ì„œ userId ê°€ì ¸ì˜¤ê¸° ì‹œë„
function getUrlParameter(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
window.onload = function() {
  // ë°©ë²• 1: URL íŒŒë¼ë¯¸í„°ì—ì„œ í™•ì¸
  userId = getUrlParameter('userId');
  
  // ë°©ë²• 2: ë¶€ëª¨ ì°½ì—ì„œ ì§ì ‘ ì „ë‹¬ë°›ì€ ë°ì´í„° í™•ì¸
  if (!userId && window.opener && window.opener.parentData) {
    userId = window.opener.parentData;
  }
  
  console.log("ì „ë‹¬ë°›ì€ userId:", userId);
  
  // userIdê°€ ìˆëŠ”ì§€ í™•ì¸
  if (!userId) {
    console.error("ì‚¬ìš©ì IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }
};

function sendGameRecord(currentScore) {
  // userId í™•ì¸
  if (!userId) {
    console.error("ì‚¬ìš©ì IDê°€ ì—†ì–´ ê¸°ë¡ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  console.log("ê¸°ë¡ ì „ì†¡ ì¤‘:", userId, $("#gameId").val(), currentScore);

  // AJAXë¥¼ í†µí•´ ê²Œì„ ê¸°ë¡ ì €ì¥
  $.ajax({
    type: "POST",
    url: "/add.record",
    data: {
      userId: userId,
      gameId: $("#gameId").val(),
      record: currentScore
    },
    success: function(response) {
      console.log("ê¸°ë¡ ì €ì¥ ì„±ê³µ:", response);
    },
    error: function(error) {
      console.error("ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:", error);
    }
  });
}
</script>

</body>
</html>